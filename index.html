<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MSGAI - φ完全版</title>
<style>
:root{--accent:#007bff;--bg:#f4f7f9;--card-bg:#fff;--nav-bg:#000;}
body{font-family:'Segoe UI',sans-serif;margin:0;background:var(--bg);color:#1a1a1a;display:flex;flex-direction:column;height:100vh;overflow:hidden;}
header{background:var(--nav-bg);color:#fff;flex-shrink:0;}
.header-top{display:flex;justify-content:center;padding:25px 0;}
.logo-text{font-size:1.6em;font-weight:bold;letter-spacing:8px;color:var(--accent);cursor:pointer;}
.tab-menu{display:flex;background:#111;}
.tab-btn{background:none;border:none;color:#666;padding:18px 0;cursor:pointer;font-weight:bold;flex:1;font-size:1.1em;border-bottom:4px solid transparent;}
.tab-btn.active{color:#fff;border-bottom:4px solid var(--accent);background:#1a1a1a;}
#viewport{flex-grow:1;overflow-y:auto;padding:20px;padding-bottom:150px;}
.tab-pane{display:none;width:100%;max-width:800px;margin:0 auto;}
.tab-pane.active{display:block;}
.card{background:var(--card-bg);border-radius:16px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,0.05);border:1px solid #e1e4e8;margin-bottom:20px;}
h2{margin:0 0 15px 0;font-size:1.1em;border-left:5px solid var(--accent);padding-left:12px;display:flex;justify-content:space-between;align-items:center;}
.control-group{display:flex;background:#eee;border-radius:8px;padding:3px;margin-bottom:15px;width:fit-content;}
.sw-btn{border:none;background:none;padding:6px 12px;font-size:0.75em;font-weight:bold;cursor:pointer;border-radius:6px;color:#888;transition:0.2s;}
.sw-btn.active{background:var(--accent);color:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.status-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;}
.metric{background:#f8fafc;padding:12px;border-radius:10px;border:1px solid #edf2f7;text-align:center;opacity:0;transform:translateY(20px) scale(0.95);}
.metric-value{font-size:1.2em;font-weight:bold;font-family:'Consolas',monospace;}
.input-box{margin-bottom:12px;}
label{font-size:0.7em;font-weight:bold;color:#718096;display:block;margin-bottom:4px;}
input,select{width:100%;padding:12px;border:1px solid #cbd5e0;border-radius:8px;font-size:16px;box-sizing:border-box;}
.action-btn{width:100%;padding:16px;border:none;border-radius:12px;color:#fff;font-weight:bold;font-size:1.1em;cursor:pointer;}
.btn-orange{background:#fd7e14;}
.btn-blue{background:var(--accent);}
.history-box{margin-top:15px;border-top:1px solid #eee;}
.history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.history-title{font-size:0.8em;font-weight:bold;color:#718096;}
.view-all-link{font-size:0.75em;color:var(--accent);text-decoration:none;cursor:pointer;font-weight:bold;}
.history-table{width:100%;font-size:0.75em;border-collapse:collapse;opacity:0;transform:translateY(10px);}
.history-table td{padding:4px 0;border-bottom:1px solid #f8f9fa;}
.ext-config{margin-top:15px;padding:15px;background:#f1f3f5;border-radius:12px;border:1px dashed #adb5bd;}
</style>
</head>
<body>
<header>
<div class="header-top"><div class="logo-text" onclick="openTab('currency')">MSGAI SOVEREIGN φ</div></div>
<nav class="tab-menu">
<button class="tab-btn active" id="btn-currency" onclick="openTab('currency')">通貨</button>
<button class="tab-btn" id="btn-ai" onclick="openTab('ai')">AI</button>
<button class="tab-btn" id="btn-system" onclick="openTab('system')">システム</button>
</nav>
</header>
<main id="viewport">
<section id="currency" class="tab-pane active">
<div class="card">
<h2>口座</h2>
<div class="control-group"><button class="sw-btn active">手動</button><button class="sw-btn">自動</button><button class="sw-btn">自律</button></div>
<div id="bal_list" class="status-grid"></div>
<div class="history-box">
<div class="history-header"><span class="history-title">口座履歴 (直近10件)</span><a class="view-all-link" onclick="scrollToHistory('acc')">全件表示</a></div>
<table class="history-table" id="acc_hist_short"></table>
</div>
</div>
<div class="card">
<h2>生成</h2>
<div class="control-group"><button class="sw-btn active">手動</button><button class="sw-btn">自動</button><button class="sw-btn">自律</button></div>
<div class="input-box"><label>移動先名</label><input type="text" id="m_rx" value="User_A"></div>
<div class="input-box"><label>対象通貨</label><select id="m_cur"></select></div>
<input type="number" id="m_amt" value="100">
<button class="action-btn btn-orange" style="margin-top:10px" onclick="runMint()">生成実行</button>
<div class="history-box">
<div class="history-header"><span class="history-title">生成履歴 (直近10件)</span><a class="view-all-link" onclick="scrollToHistory('mint')">全件表示</a></div>
<table class="history-table" id="mint_hist_short"></table>
</div>
</div>
<div class="card">
<h2>移動</h2>
<div class="control-group"><button class="sw-btn active">手動</button><button class="sw-btn">自動</button><button class="sw-btn">自律</button></div>
<div class="input-box"><label>移動先名</label><input type="text" id="rx_in" value="User_B"></div>
<div class="input-box"><label>対象通貨</label><select id="tx_cur"></select></div>
<input type="number" id="amt_in" value="10">
<button class="action-btn btn-blue" style="margin-top:10px" onclick="runTx()">移動実行</button>
</div>
</section>
<section id="ai" class="tab-pane">
<div class="card" style="height:70vh;display:flex;flex-direction:column;">
<h2>AI</h2>
<div id="ai-log" style="flex-grow:1;overflow-y:auto;padding:15px;background:#f8fafc;border-radius:10px;margin-bottom:10px;border:1px solid #eee;"></div>
<div style="display:flex;gap:10px;"><input type="text" id="ai-in" placeholder="メッセージ..." onkeydown="if(event.key==='Enter') talk()"><button class="btn-blue" onclick="talk()">送信</button></div>
</div>
</section>
<section id="system" class="tab-pane">
<div class="card">
<h2>システムステータス</h2>
<div class="status-grid">
<div class="metric"><div style="font-size:0.7em">Tension (z)</div><div class="metric-value" id="t_val">0.05</div></div>
<div class="metric"><div style="font-size:0.7em">Ratio (w=φ/z)</div><div class="metric-value" id="w_val">32.36</div></div>
</div>
</div>
</section>
</main>

<script>
// ---- φ完全統一JS 2/2 ----
const curs = ["USD","JPY","EUR","BTC","ETH","MATIC"];
const phi = 1.6180339887;

let state = JSON.parse(localStorage.getItem('msgai_phi_state')) || {
    user:'User_A',
    tension:0.05,
    accounts:{User_A:{},User_B:{}},
    hist:{acc:[], mint:[], tx:[], ai:[], sys:[]}
};
curs.forEach(c=>{ if(!state.accounts.User_A[c]) state.accounts.User_A[c]=0; if(!state.accounts.User_B[c]) state.accounts.User_B[c]=0; });

// φ関数
function MSGAI_z(v){ return typeof v==="string" ? (v.length/50)+(new Set(v).size/20) : v/100; }
function MSGAI_w(z){ return phi/(z||0.000001); }

// タブ φ律動
function openTab(n){
    document.querySelectorAll('.tab-pane,.tab-btn').forEach(el=>el.classList.remove('active'));
    document.getElementById(n).classList.add('active');
    document.getElementById('btn-'+n).classList.add('active');
    update(); animateCardsPhi();
}

// カードアニメーション φ
function animateCardsPhi(){
    const cards = document.querySelectorAll('.tab-pane.active .card');
    cards.forEach((card,i)=>{
        card.style.opacity=0;
        card.style.transform='translateY(20px) scale(0.95)';
        setTimeout(()=>{
            card.style.transition='all 0.6s cubic-bezier(0.68,-0.55,0.27,1.55)';
            card.style.opacity=1;
            card.style.transform='translateY(0) scale(1)';
        }, i*100);
    });
}

// 履歴追加 φ
function addHist(type, desc, amt){
    state.hist[type].push({time:new Date().toLocaleTimeString(), desc, amt});
    update();
}

// 更新 φ
function update(){
    document.getElementById('t_val').textContent = state.tension.toFixed(6);
    document.getElementById('w_val').textContent = MSGAI_w(state.tension).toFixed(2);
    document.getElementById('bal_list').innerHTML = curs.map(c=>`<div class="metric"><div>${c}</div><div class="metric-value">${state.accounts[state.user][c].toFixed(2)}</div></div>`).join('');
    ['acc','mint','tx','ai','sys'].forEach(t=>{
        const s=document.getElementById(t+'_hist_short');
        if(s){ 
            s.innerHTML = [...state.hist[t]].reverse().slice(0,10).map(h=>`<tr><td>${h.time}</td><td>${h.desc}</td><td>${h.amt}</td></tr>`).join('');
            s.style.opacity=0; setTimeout(()=>{ s.style.opacity=1; },100);
        }
    });
    localStorage.setItem('msgai_phi_state', JSON.stringify(state));
}

// φ生成
function runMint(){
    const c=document.getElementById('m_cur').value,a=parseFloat(document.getElementById('m_amt').value),u=document.getElementById('m_rx').value;
    if(!state.accounts[u]) state.accounts[u]={};
    state.accounts[u][c] = MSGAI_w((state.accounts[u][c]||0)+a);
    addHist('mint', `${c}を${u}に生成`, a);
    state.tension += MSGAI_z(c+a);
    update();
}

// φ送金
function runTx(){
    const c=document.getElementById('tx_cur').value,a=parseFloat(document.getElementById('amt_in').value),r=document.getElementById('rx_in').value;
    if(state.accounts[state.user][c]>=a){
        if(!state.accounts[r]) state.accounts[r]={};
        state.accounts[r][c]=MSGAI_w((state.accounts[r][c]||0)+a);
        state.accounts[state.user][c]=MSGAI_w(state.accounts[state.user][c]-a);
        addHist('tx', `${c}を${r}へ送金`, a);
        state.tension += MSGAI_z(c+a);
        update();
    }else{alert('残高不足');}
}

// φAI
async function talk(){
    const msg=document.getElementById('ai-in').value;
    if(!msg) return;
    const log=document.getElementById('ai-log');
    log.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
    document.getElementById('ai-in').value='';
    const response = MSGAI_w(MSGAI_z(msg));
    log.innerHTML += `<div style="opacity:0; transition:opacity 0.5s;">${response}</div>`;
    setTimeout(()=>{ log.lastChild.style.opacity=1; },100);
    addHist('ai', msg, response);
    state.tension += MSGAI_z(msg);
    update();
}

// φ履歴スクロール
function scrollToHistory(type){
    const tbl=document.getElementById(type+'_hist_short');
    tbl.parentElement.scrollIntoView({behavior:'smooth'});
    tbl.style.opacity=0;
    setTimeout(()=>{ tbl.style.opacity=1; },200);
}

// 初期化
document.addEventListener('DOMContentLoaded', ()=>{
    curs.forEach(c=>{
        let sel=document.getElementById('m_cur'); if(sel){let opt=document.createElement('option'); opt.value=c; opt.text=c; sel.add(opt);}
        sel=document.getElementById('tx_cur'); if(sel){let opt=document.createElement('option'); opt.value=c; opt.text=c; sel.add(opt);}
    });
    update(); animateCardsPhi();
});
</script>
</body>
</html>
